#= depend_on_asset "editor.html"

ContactApp = angular.module('ContactApp', ['ngResource'])

ContactApp.config ($httpProvider) ->
  authToken = $("meta[name=\"csrf-token\"]").attr("content")
  $httpProvider.defaults.headers.common["X-CSRF-TOKEN"] = authToken

ContactApp.factory 'Contacts', ($resource) ->
  class Contacts
    constructor: ->
      @service = $resource '/api/contacts/:id', {id: '@id'},
        'update': { method: 'PUT' }

    all: ->
      @service.query()

    update: (contact) ->
      new @service.update({id: contact.id}, {contact: contact}).$promise
        .then ((contact) -> ), ((error) -> console.log error)
      contact

    create: (attrs) ->
      new @service({contact: attrs}).$save (contact) ->
        attrs.id = contact.id
      attrs

ContactApp.controller 'ContactControl', ($scope, Contacts) ->
  $scope.init = ->
    @service = new Contacts()
    $scope.viewing = false
    $scope.editing = false
    $scope.contacts = @service.all()

  $scope.newContact = ->
    $scope.showEditor()

  $scope.save = (contact) ->
    saved = if contact.id
      @service.update(contact)
    else
      saved = @service.create(contact)
      $scope.contacts.push saved
      saved

    $scope.showContact(saved)

  $scope.showEditor = (contact) ->
    $scope.viewing = false
    $scope.editing = true
    $scope.contact = contact

  $scope.showContact = (contact) ->
    $scope.viewing = true
    $scope.editing = false
    $scope.contact = contact

  $scope.truncate = (string, max) ->
    return string if string.length <= max
    string.substring(0, max-3) + "..."

ContactApp.directive 'editor', () ->
  restrict: 'E',
  templateUrl: '<%= asset_path("editor.html") %>'
